document.addEventListener("DOMContentLoaded",()=>{const s=Stripe("pk_test_51Sa0pWH25MTLyq3jHD7KDrt815PnrZVyWi8FdfP3PPqbaTBo17kLVlCDTlo8neYB08k7AVUAKofDo5chHSt92OV200jq0oztaO"),r=s.elements().create("card",{hidePostalCode:!0,style:{base:{fontSize:"16px",color:"#1a1a1a","::placeholder":{color:"#888"}},invalid:{color:"#ff4d4f"}}});r.mount("#card-element");const e=document.getElementById("pay-btn"),t=document.getElementById("card-errors");e.addEventListener("click",async n=>{n.preventDefault(),t.textContent="",e.disabled=!0,e.innerText="Processing...";try{const a=document.getElementById("first_name").value,E=document.getElementById("last_name").value,h=document.getElementById("phone_number").value,m=document.querySelector('input[name="address_id"]:checked'),u=m?m.value:0,v=document.getElementById("street").value,g=document.getElementById("city").value,_=document.getElementById("province").value,S=document.getElementById("postal_code").value,B=document.getElementById("country").value,I=parseFloat(document.querySelector("[data-total]").value,10),o=await fetch("/checkout/payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector("meta[name=csrf-token]").content},body:JSON.stringify({amount:I,first_name:a,last_name:E,phone_number:h,address_id:u,street:v,city:g,province:_,postal_code:S,country:B})}),y=["first_name","last_name","phone_number","street","city","province","postal_code","country"],w=["address",...y];if(f(w,!0),!o.ok)if(o.status===422){const l=await o.json();if(console.log("Validation errors:",l.errors),u===0){const C=document.getElementById("address-error");C.textContent="Please add new address with valid info."}f(y,!1,l)}else throw new Error(`Server returned ${o.status}`);let d;try{d=await o.json()}catch{throw new Error("Invalid JSON response from server")}const p=d.clientSecret,b=d.orderNumber;if(!p)throw new Error("No clientSecret returned from server");const c=await s.confirmCardPayment(p,{payment_method:{card:r}});c.error?(t.textContent=c.error.message,e.disabled=!1,e.innerText="Place Order"):c.paymentIntent&&c.paymentIntent.status==="succeeded"&&(window.location.href=`/checkout/success/${b}`)}catch(a){console.error(a),t.textContent=`Payment failed: ${a.message}`,e.disabled=!1,e.innerText="Place Order"}}),r.on("change",n=>{t.textContent=n.error?n.error.message:""})});function f(s,i=!0,r=[]){s.forEach(e=>{const t=document.getElementById(`${e}-error`);if(t){let n="";i||(n=r.errors[e]?r.errors[e][0]:""),t.textContent=n}})}
